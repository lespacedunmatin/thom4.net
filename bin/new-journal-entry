#!/usr/bin/env node

const {choose, prompt, confirm} = require('promptly')
const H = require('hexo')
const { slugize } = require('hexo-util')
const moment = require('moment')
const hexo = new H(process.cwd(), {})

hexo.init().then(async () => {
  const title = await prompt('Title: ')
  const slug = await prompt(`Slug [${slugize(title.toLocaleLowerCase())}]`, {default: slugize(title.toLocaleLowerCase())})
  const lang = await choose('Lang [fr-FR]: ', ['fr-FR', 'en-GB'], {default: 'fr-FR'})
  const categories = ['Journal']
    .concat((await prompt('Categories []: ', {default: ''})).split(','))
    .filter(c => c)
  const content = await prompt('Body: ')

  const now = moment()
  const permalink = `${now.format('MM[/]DD')}/${slug}`

  return {title, content, categories, lang, permalink, layout: 'journal'}
})
.then((data) => hexo.post.create(data, true))
.catch(error => {
  // manually cancelled prompts do no throw
  if (error.message.match('canceled')) {
    return true
  }

  throw error
})
